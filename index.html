<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Фото-Ксерокопия</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            margin: 20px;
        }
        canvas {
            margin-top: 10px;
            border: 1px solid black;
            max-width: 100%;
            height: auto;
        }
        .loading {
            display: none;
            margin-top: 10px;
            font-size: 16px;
            color: gray;
        }
        .error {
            color: red;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <h1>Сделать фото как ксерокопию</h1>
    <input type="file" id="upload" accept="image/*">
    <p class="loading">Загрузка...</p>
    <canvas id="canvas"></canvas>
    <button id="download">Скачать</button>
    <p id="error" class="error"></p>

    <script>
        const upload = document.getElementById('upload');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const downloadButton = document.getElementById('download');
        const loadingText = document.querySelector('.loading');
        const errorText = document.getElementById('error');

        // Функция для применения контраста
        function applyContrast(imageData, contrast) {
            const data = imageData.data;
            for (let i = 0; i < data.length; i += 4) {
                const avg = (data[i] + data[i + 1] + data[i + 2]) / 3;
                let newPixelValue = Math.max(0, Math.min(255, (avg - 128) * contrast + 128));
                data[i] = newPixelValue;       // Red
                data[i + 1] = newPixelValue;   // Green
                data[i + 2] = newPixelValue;   // Blue
            }
        }

        upload.addEventListener('change', function(event) {
            errorText.textContent = ''; // Очищаем предыдущие ошибки
            const file = event.target.files[0];
            if (!file) return;

            if (!['image/jpeg', 'image/png', 'image/gif'].includes(file.type)) {
                errorText.textContent = 'Ошибка: поддерживаемые форматы — JPEG, PNG, GIF.';
                return;
            }

            const reader = new FileReader();
            loadingText.style.display = 'block'; // Показываем индикатор загрузки
            reader.onload = function(e) {
                const img = new Image();
                img.src = e.target.result;
                img.onload = function() {
                    canvas.width = img.width;
                    canvas.height = img.height;
                    ctx.drawImage(img, 0, 0);

                    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                    applyContrast(imageData, 2); // Применяем контраст (значение можно изменить)
                    ctx.putImageData(imageData, 0, 0);

                    loadingText.style.display = 'none'; // Скрываем индикатор загрузки
                    downloadButton.disabled = false; // Активируем кнопку скачивания
                };
            };
            reader.readAsDataURL(file);
        });

        downloadButton.addEventListener('click', function() {
            const link = document.createElement('a');
            link.download = 'xerox-photo.jpg';
            link.href = canvas.toDataURL('image/jpeg', 0.8); // Оптимизируем качество JPEG до 80%
            link.click();
        });

        downloadButton.disabled = true; // Изначально кнопка скачивания отключена
    </script>
</body>
</html>
