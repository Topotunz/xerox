<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Эффект Изогелия</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            margin: 20px;
        }
        canvas {
            margin-top: 10px;
            border: 1px solid black;
            max-width: 100%;
            height: auto;
        }
        .loading {
            display: none;
            margin-top: 10px;
            font-size: 16px;
            color: gray;
        }
        .error {
            color: red;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <h1>Создание эффекта изогелия</h1>
    <input type="file" id="upload" accept="image/*">
    <p class="loading">Обработка...</p>
    <canvas id="canvas"></canvas>
    <button id="download">Скачать</button>
    <p id="error" class="error"></p>

    <script>
        const upload = document.getElementById('upload');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const downloadButton = document.getElementById('download');
        const loadingText = document.querySelector('.loading');
        const errorText = document.getElementById('error');

        // Функция для создания эффекта изогелия
        function createIsogelEffect(imageData) {
            const data = imageData.data;
            const width = imageData.width;
            const height = imageData.height;

            // Создаем градиент яркости (по сути, детектор краев)
            for (let y = 1; y < height - 1; y++) {
                for (let x = 1; x < width - 1; x++) {
                    const index = (y * width + x) * 4;

                    // Вычисляем среднюю яркость соседних пикселей
                    const currentBrightness = (data[index] + data[index + 1] + data[index + 2]) / 3;

                    // Соседние пиксели
                    const topBrightness = (data[index - width * 4] + data[index - width * 4 + 1] + data[index - width * 4 + 2]) / 3;
                    const bottomBrightness = (data[index + width * 4] + data[index + width * 4 + 1] + data[index + width * 4 + 2]) / 3;
                    const leftBrightness = (data[index - 4] + data[index - 3] + data[index - 2]) / 3;
                    const rightBrightness = (data[index + 4] + data[index + 5] + data[index + 6]) / 3;

                    // Вычисляем разницу яркости (градиент)
                    const gradientX = Math.abs(leftBrightness - rightBrightness);
                    const gradientY = Math.abs(topBrightness - bottomBrightness);

                    // Общая интенсивность градиента
                    const intensity = Math.sqrt(gradientX * gradientX + gradientY * gradientY);

                    // Применяем инверсию для создания темных контуров
                    const pixelValue = 255 - Math.min(255, intensity * 2);

                    data[index] = pixelValue;       // Red
                    data[index + 1] = pixelValue;   // Green
                    data[index + 2] = pixelValue;   // Blue
                }
            }
        }

        upload.addEventListener('change', function(event) {
            errorText.textContent = ''; // Очищаем предыдущие ошибки
            const file = event.target.files[0];
            if (!file) return;

            if (!['image/jpeg', 'image/png', 'image/gif'].includes(file.type)) {
                errorText.textContent = 'Ошибка: поддерживаемые форматы — JPEG, PNG, GIF.';
                return;
            }

            const reader = new FileReader();
            loadingText.style.display = 'block'; // Показываем индикатор загрузки
            reader.onload = function(e) {
                const img = new Image();
                img.src = e.target.result;
                img.onload = function() {
                    canvas.width = img.width;
                    canvas.height = img.height;
                    ctx.drawImage(img, 0, 0);

                    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                    createIsogelEffect(imageData); // Применяем эффект изогелия
                    ctx.putImageData(imageData, 0, 0);

                    loadingText.style.display = 'none'; // Скрываем индикатор загрузки
                    downloadButton.disabled = false; // Активируем кнопку скачивания
                };
            };
            reader.readAsDataURL(file);
        });

        downloadButton.addEventListener('click', function() {
            const link = document.createElement('a');
            link.download = 'isogel-photo.jpg';
            link.href = canvas.toDataURL('image/jpeg', 0.8); // Оптимизируем качество JPEG до 80%
            link.click();
        });

        downloadButton.disabled = true; // Изначально кнопка скачивания отключена
    </script>
</body>
</html>
